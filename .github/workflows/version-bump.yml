name: PR Version Bump & Merge

on:
  issue_comment:
    types: [created]

jobs:
  bump-and-merge:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/mergebot') }}
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Enviar mensaje de inicio del proceso
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="üõ†Ô∏è Iniciando proceso de merge solicitado con \`/mergebot\`‚Ä¶"

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Obtener rama del PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr checkout ${{ github.event.issue.number }}

      - name: Configurar identidad Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Determine Bump Type
        id: bump-type
        run: |
          COMMENT="${{ github.event.comment.body }}"
          if [[ "$COMMENT" == *"/mergebot patch"* ]]; then
            echo "TYPE=patch" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == *"/mergebot minor"* ]]; then
            echo "TYPE=minor" >> $GITHUB_OUTPUT
          elif [[ "$COMMENT" == *"/mergebot major"* ]] || [[ "$COMMENT" == *"/mergebot mayor"* ]]; then
            echo "TYPE=major" >> $GITHUB_OUTPUT
          else
            echo "TYPE=none" >> $GITHUB_OUTPUT
          fi

      - name: Update Version
        id: update-version
        if: ${{ steps.bump-type.outputs.TYPE != 'none' }}
        env:
          BUMP_TYPE: ${{ steps.bump-type.outputs.TYPE }}
        run: |
          node -e '
            const fs = require("fs");
            const path = "main/script.user.js";
            if (!fs.existsSync(path)) {
              console.error("File not found:", path);
              process.exit(1);
            }

            let content = fs.readFileSync(path, "utf8");
            const regex = /\/\/ @version\s+(\d+\.\d+\.\d+)/;
            const match = content.match(regex);

            if (!match) {
              console.error("Version not found in file");
              process.exit(1);
            }

            let [major, minor, patch] = match[1].split(".").map(Number);
            const type = process.env.BUMP_TYPE;

            if (type === "major") { major++; minor = 0; patch = 0; }
            else if (type === "minor") { minor++; patch = 0; }
            else if (type === "patch") { patch++; }

            const newVer = `${major}.${minor}.${patch}`;
            content = content.replace(regex, `// @version      ${newVer}`);
            fs.writeFileSync(path, content);

            console.log("Bumped version to", newVer);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `NEW_VERSION=${newVer}\n`);
          '

      - name: Error rebase ‚Üí comentar en PR
        if: ${{ steps.rebase.outputs.REBASE_FAILED == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          gh api repos/${GITHUB_REPOSITORY}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚ùå No se pudo actualizar la versi√≥n, revisa el log: $RUN_URL.  
            Existen conflictos que deben resolverse manualmente."
          exit 1

      - name: Commit and Push
        if: steps.bump-type.outputs.TYPE != 'none'
        continue-on-error: true
        run: |
          git rebase origin/main || echo "REBASE_FAILED=true" >> $GITHUB_OUTPUT
          git add main/script.user.js
          git commit -m "bump version to ${{ steps.update-version.outputs.NEW_VERSION }}"
          git push

      - name: Error rebase ‚Üí comentar en PR
        if: ${{ steps.rebase.outputs.REBASE_FAILED == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚ùå No se pudo hacer **rebase con main**.  
            Existen conflictos que deben resolverse manualmente."
          exit 1

      - name: Merge PR
        id: merge
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.issue.number }} --merge --delete-branch || \
          echo "MERGE_FAILED=true" >> $GITHUB_OUTPUT

      - name: Error merge ‚Üí comentar en PR
        if: ${{ steps.merge.outputs.MERGE_FAILED == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚ùå No se pudo hacer el **merge**.  
            Puede haber conflictos o requisitos que impidan mergear el PR."

      - name: Merge correcto ‚Üí comentar √©xito
        if: ${{ steps.merge.outputs.MERGE_FAILED != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -f body="‚úÖ Merge completado con √©xito.  
            Versi√≥n actualizada a \`${{ steps.update-version.outputs.NEW_VERSION }}\`."
